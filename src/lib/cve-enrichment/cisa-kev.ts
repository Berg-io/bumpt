const CISA_KEV_FEED_URL =
  "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json";
const CACHE_TTL_MS = 6 * 60 * 60 * 1000;

let cache: { fetchedAt: number; cves: Set<string> } | null = null;

interface CisaKevVuln {
  cveID?: string;
}

interface CisaKevFeed {
  vulnerabilities?: CisaKevVuln[];
}

async function loadKevSet(): Promise<Set<string>> {
  const now = Date.now();
  if (cache && now - cache.fetchedAt < CACHE_TTL_MS) {
    return cache.cves;
  }

  const res = await fetch(CISA_KEV_FEED_URL, {
    headers: { Accept: "application/json" },
    signal: AbortSignal.timeout(20000),
  });
  if (!res.ok) return cache?.cves ?? new Set<string>();

  const data = (await res.json()) as CisaKevFeed;
  const vulnerabilities = data.vulnerabilities ?? [];
  const cves = new Set<string>();
  for (const vuln of vulnerabilities) {
    const cve = vuln.cveID?.toUpperCase();
    if (cve && cve.startsWith("CVE-")) cves.add(cve);
  }

  cache = { fetchedAt: now, cves };
  return cves;
}

export async function queryCisaKevMatches(cves: string[]): Promise<string[]> {
  const normalized = [...new Set(cves.map((cve) => cve.toUpperCase()))];
  if (normalized.length === 0) return [];
  try {
    const kev = await loadKevSet();
    return normalized.filter((cve) => kev.has(cve));
  } catch {
    return [];
  }
}
