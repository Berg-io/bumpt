import { getAppSetting } from "@/lib/settings";

const GH_ADVISORIES_API = "https://api.github.com/advisories";

export async function queryGitHubAdvisory(
  ecosystem: string,
  packageName: string
): Promise<string[]> {
  const token = await getAppSetting("github_token") || process.env.GITHUB_TOKEN;

  const params = new URLSearchParams({
    affects: packageName,
    per_page: "20",
  });
  if (ecosystem) {
    params.set("ecosystem", ecosystem);
  }

  const headers: Record<string, string> = {
    Accept: "application/vnd.github+json",
    "User-Agent": "bumpt/1.0",
    "X-GitHub-Api-Version": "2022-11-28",
  };
  if (token) {
    headers.Authorization = `token ${token}`;
  }

  const res = await fetch(`${GH_ADVISORIES_API}?${params}`, {
    headers,
    signal: AbortSignal.timeout(15000),
  });

  if (!res.ok) return [];

  const advisories = await res.json() as Array<{
    cve_id: string | null;
    ghsa_id: string;
  }>;

  if (!Array.isArray(advisories)) return [];

  const cves: string[] = [];
  for (const advisory of advisories) {
    if (advisory.cve_id?.startsWith("CVE-")) {
      cves.push(advisory.cve_id.toUpperCase());
    }
  }

  return cves;
}
