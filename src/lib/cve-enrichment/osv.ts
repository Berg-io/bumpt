const OSV_API = "https://api.osv.dev/v1/query";
const CVE_PREFIX = /^CVE-/i;

export async function queryOsv(
  ecosystem: string,
  packageName: string,
  version: string
): Promise<string[]> {
  const body = {
    package: { name: packageName, ecosystem },
    version,
  };

  const res = await fetch(OSV_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    signal: AbortSignal.timeout(15000),
  });

  if (!res.ok) return [];

  const data = await res.json();
  const vulns = data.vulns as Array<{ aliases?: string[] }> | undefined;
  if (!vulns || vulns.length === 0) return [];

  const cves = new Set<string>();
  for (const vuln of vulns) {
    if (vuln.aliases) {
      for (const alias of vuln.aliases) {
        if (CVE_PREFIX.test(alias)) {
          cves.add(alias.toUpperCase());
        }
      }
    }
  }

  return [...cves];
}
