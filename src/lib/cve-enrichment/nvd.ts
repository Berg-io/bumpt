import { getAppSetting } from "@/lib/settings";

const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

let lastNvdCall = 0;

async function rateLimitWait(hasApiKey: boolean) {
  const minInterval = hasApiKey ? 600 : 6000;
  const elapsed = Date.now() - lastNvdCall;
  if (elapsed < minInterval) {
    await new Promise((r) => setTimeout(r, minInterval - elapsed));
  }
  lastNvdCall = Date.now();
}

export async function queryNvd(
  productName: string,
  version?: string
): Promise<string[]> {
  const apiKey = await getAppSetting("nvd_api_key");
  await rateLimitWait(!!apiKey);

  const params = new URLSearchParams({
    keywordSearch: version ? `${productName} ${version}` : productName,
    resultsPerPage: "20",
  });

  const headers: Record<string, string> = {};
  if (apiKey) {
    headers.apiKey = apiKey;
  }

  const res = await fetch(`${NVD_API}?${params}`, {
    headers,
    signal: AbortSignal.timeout(20000),
  });

  if (!res.ok) return [];

  const data = await res.json();
  const vulnerabilities = data.vulnerabilities as Array<{
    cve: {
      id: string;
      configurations?: Array<{
        nodes?: Array<{
          cpeMatch?: Array<{
            criteria: string;
            versionStartIncluding?: string;
            versionEndExcluding?: string;
            versionEndIncluding?: string;
          }>;
        }>;
      }>;
    };
  }> | undefined;

  if (!vulnerabilities || vulnerabilities.length === 0) return [];

  const cves: string[] = [];
  for (const vuln of vulnerabilities) {
    const cveId = vuln.cve.id;
    if (!cveId?.startsWith("CVE-")) continue;

    if (version && vuln.cve.configurations) {
      const matchesVersion = vuln.cve.configurations.some((config) =>
        config.nodes?.some((node) =>
          node.cpeMatch?.some((match) => {
            const criteria = match.criteria.toLowerCase();
            return criteria.includes(productName.toLowerCase());
          })
        )
      );
      if (!matchesVersion) continue;
    }

    cves.push(cveId.toUpperCase());
  }

  return cves;
}
