import { getAppSetting } from "@/lib/settings";

const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

let lastNvdCall = 0;

async function rateLimitWait(hasApiKey: boolean) {
  const minInterval = hasApiKey ? 600 : 6000;
  const elapsed = Date.now() - lastNvdCall;
  if (elapsed < minInterval) {
    await new Promise((r) => setTimeout(r, minInterval - elapsed));
  }
  lastNvdCall = Date.now();
}

function buildMatchTokens(productName: string): string[] {
  const cleaned = productName
    .toLowerCase()
    .replace(/[^a-z0-9._/\- ]+/g, " ")
    .replace(/[_\-./]+/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  if (!cleaned) return [];
  const rawTokens = cleaned.split(" ").filter((t) => t.length >= 2);
  // Keep unique and prioritize longer tokens for better precision.
  const unique = [...new Set(rawTokens)];
  return unique.sort((a, b) => b.length - a.length).slice(0, 4);
}

export async function queryNvd(
  productName: string,
  version?: string
): Promise<string[]> {
  const apiKey = await getAppSetting("nvd_api_key");
  await rateLimitWait(!!apiKey);

  const params = new URLSearchParams({
    keywordSearch: version ? `${productName} ${version}` : productName,
    resultsPerPage: "20",
  });

  const headers: Record<string, string> = {};
  if (apiKey) {
    headers.apiKey = apiKey;
  }

  const res = await fetch(`${NVD_API}?${params}`, {
    headers,
    signal: AbortSignal.timeout(20000),
  });

  if (!res.ok) return [];

  const data = await res.json();
  const vulnerabilities = data.vulnerabilities as Array<{
    cve: {
      id: string;
      configurations?: Array<{
        nodes?: Array<{
          cpeMatch?: Array<{
            criteria: string;
            versionStartIncluding?: string;
            versionEndExcluding?: string;
            versionEndIncluding?: string;
          }>;
        }>;
      }>;
    };
  }> | undefined;

  if (!vulnerabilities || vulnerabilities.length === 0) return [];
  const tokens = buildMatchTokens(productName);

  const cves: string[] = [];
  for (const vuln of vulnerabilities) {
    const cveId = vuln.cve.id;
    if (!cveId?.startsWith("CVE-")) continue;

    if (version && vuln.cve.configurations && tokens.length > 0) {
      const matchesVersion = vuln.cve.configurations.some((config) =>
        config.nodes?.some((node) =>
          node.cpeMatch?.some((match) => {
            const criteria = match.criteria.toLowerCase();
            return tokens.some((token) => criteria.includes(token));
          })
        )
      );
      if (!matchesVersion) continue;
    }

    cves.push(cveId.toUpperCase());
  }

  return cves;
}
